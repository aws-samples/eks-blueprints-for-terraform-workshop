{{- if .Values.repo }}
{{- range $env := .Values.environments }}
{{- if ne $env.name "prod" }}  # non-prod only
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: "deployment-{{ $.Values.workloadName }}-{{ $env.name }}"
spec:
  goTemplate: true
  goTemplateOptions:
    - missingkey=error

  generators:
    - git:
        repoURL: "{{ $.Values.repo }}"
        revision: HEAD
        directories:
          # webstore/<service>/<env>, e.g. webstore/ui/dev
          - path: "{{ $.Values.workloadName }}/*/{{ $env.name }}"

  template:
    metadata:
      # path example: webstore/catalog/dev
      # .path.segments = ["webstore", "catalog", "dev"]
      # service = index .path.segments 1 = "catalog"
      name: "{{ $.Values.workloadName }}-{{`{{ index .path.segments 1 }}`}}-{{ $env.name }}"
      labels:
        workload: "{{ $.Values.workloadName }}"
        service: "{{`{{ index .path.segments 1 }}`}}"
        env: "{{ $env.name }}"

    spec:
      project: "{{ $.Values.workloadName }}-nonprod"
      source:
        repoURL: "{{ $.Values.repo }}"
        targetRevision: HEAD
        # full path like: webstore/catalog/dev
        path: "{{`{{ .path.path }}`}}"

      destination:
        # per-env cluster from environments.json
        name: "{{ $env.cluster }}"
        namespace: "{{`{{ index .path.segments 1 }}`}}"
        # you can add namespace if you want per-env namespaces:
        # namespace: "{{ $.Values.workloadName }}-{{ $env.name }}"

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
{{- end }}
{{- end }}
{{- end }}
