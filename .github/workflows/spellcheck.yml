name: Spellcheck

on:
  push:
  pull_request:

# Limit concurrent runs and cancel in-progress runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  spellcheck:
    if: true # deactivate it (need private gitlab to work)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better context

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'  # Use built-in caching

    - name: Install Dependencies
      run: |
        #corepack enable
        #yarn install --immutable
        # Install cspell globally
        set -x
        #yarn add --dev -W cspell
        #yarn add --dev -W --no-lockfile cspell --ignore-optional --ignore-scripts
        npm install -g cspell

    - name: Run Spellcheck
      id: spellcheck
      continue-on-error: true  # Allow workflow to continue for reporting
      run: |
        echo "### Spellcheck Results" >> $GITHUB_STEP_SUMMARY
        echo "start" >> $GITHUB_STEP_SUMMARY
        
        mkdir -p tmp

        # Capture output and exit code
        set +e
        yarn spelling:ci-check | tee ./tmp/spellcheck_output.txt
        #SPELLCHECK_EXIT_CODE=$?
        SPELLCHECK_EXIT_CODE=${PIPESTATUS[0]}  # Capture the exit code of cspell, not tee
        echo "Exit code: $SPELLCHECK_EXIT_CODE"
        set -e
        
        set -x
        # Add output to step summary
        cat ./tmp/spellcheck_output.txt >> $GITHUB_STEP_SUMMARY
        echo "end" >> $GITHUB_STEP_SUMMARY
        
        # Determine job status
        if [[ "${SPELLCHECK_EXIT_CODE:-0}" -ne "0" ]]; then
          echo "spellcheck_failed=true" >> $GITHUB_ENV
          exit 1
        else
          echo "spellcheck_failed=false" >> $GITHUB_ENV
          exit 0
        fi

    - name: Create PR Comment
      if: steps.spellcheck.outcome != 'success' && 
          github.event_name == 'pull_request'

      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const workflowRunUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          // Read spellcheck output
          let spellcheckOutput = '';
          try {
            spellcheckOutput = fs.readFileSync('./tmp/spellcheck_output.txt', 'utf8');
          } catch (error) {
            console.log('Could not read spellcheck output file');
          }

          // Ensure we have content
          if (!spellcheckOutput) {
            spellcheckOutput = 'No spellcheck output available. Please check the workflow run for details.';
          }

          // Truncate output if too long
          const MAX_COMMENT_LENGTH = 65000;
          const truncatedOutput = spellcheckOutput.length > MAX_COMMENT_LENGTH 
            ? spellcheckOutput.substring(0, MAX_COMMENT_LENGTH) + '...\n[Output truncated]'
            : spellcheckOutput;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `
              ### ðŸš¨ Spellcheck Failed

              Spellcheck detected potential spelling issues in the repository. Please review and address them.

              [View Workflow Run](${workflowRunUrl})

              #### Spellcheck Output:
              \`\`\`
              ${truncatedOutput}
              \`\`\`

              **How to Fix:**
              1. Correct spelling errors in content files
              2. Add correctly spelled but unrecognized words to \`cspell.config.yaml\`
              3. Run \`yarn spelling:check\` locally to verify
              4. Commit and push changes
              5. install locall checks before commit:
                \`\`\`bash
                sudo git config --system --unset-all core.hookspath
                pre-commit install
              \`\`\``
          });

    # Fail the job if spellcheck failed
    - name: Check Spellcheck Status
      if: steps.spellcheck.outcome != 'success'
      run: exit 1
